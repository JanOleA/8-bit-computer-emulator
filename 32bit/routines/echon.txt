;! name: ECHON
;! entry: start
;! deps:
;! abi: os
;! bss: none
;! align: 100

; Prints exactly N characters from pointer .arg1, then newline.
; Inputs:
;   .arg1 = pointer to first character
;   .num_digits = count (N)

start:
  ; If .num_digits == 0, compute length until null (cap 80)
  LDA .num_digits
  CPI 0
  JPZ en_compute_len
  JMP en_print

en_compute_len:
  LDI 0
  STA .num_digits
en_len_loop:
  ; read *(arg1 + num_digits)
  LDA .arg1
  ADD .num_digits
  PHA
  LAS
  CPI 0
  JPZ en_len_done
  ; inc length
  LDA .num_digits
  ADI 1
  STA .num_digits
  ; cap at 80
  LDA .num_digits
  CPI 80
  JPZ en_len_done
  JMP en_len_loop
en_len_done:
  ; fallthrough to printing

en_print:

lp:
  ; load *arg1 into .char
  LDA .arg1
  PHA
  LAS
  STA .char
  ; write char
  JSR write_char
  ; advance arg1 and decrement N
  LDA .arg1
  ADI 1
  STA .arg1
  LDA .num_digits
  SUI 1
  STA .num_digits
  JPZ end_nl
  JMP lp

end_nl:
  JSR newline
  RET

; --- display helpers ---
write_char:
  LDD .char
  DIC 0
  DIC 64
  DIC 192
  DIC 0
  RET

newline:
  DIS 32
  DIC 0
  DIC 128
  DIC 0
  RET
